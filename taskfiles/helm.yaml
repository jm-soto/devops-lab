version: '3'

# ========================================
# TAREAS DE HELM staging
# ========================================

vars:
  CHART_PATH: helm/devops-lab-app
  RELEASE_NAME: devops-lab-app
  NAMESPACE: devops-lab-staging

tasks:
  template:
    desc: ğŸ“„ Generar templates YAML del chart sbx (sin instalar)
    cmds:
      - helm template {{.RELEASE_NAME}} {{.CHART_PATH}} -f cd/staging/values.yaml -n {{.NAMESPACE}}

  install:
    desc: ğŸš€ Instalar/Actualizar la aplicaciÃ³n usando Helm
    cmds:
      - helm upgrade --install {{.RELEASE_NAME}} {{.CHART_PATH}} -f cd/staging/values.yaml -n {{.NAMESPACE}} --create-namespace
      - echo "âœ“ AplicaciÃ³n instalada/actualizada en entorno sbx"

  uninstall:
    desc: ğŸ—‘ï¸  Desinstalar la aplicaciÃ³n
    cmds:
      - helm uninstall {{.RELEASE_NAME}} -n {{.NAMESPACE}}
      - echo "âœ“ AplicaciÃ³n desinstalada en entorno staging"

# ========================================
# TAREAS DE MONITOREO (Prometheus + Grafana)
# ========================================

  monitoring:install:
    desc: ğŸ“Š Instalar Prometheus y Grafana (kube-prometheus-stack)
    cmds:
      - helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      - helm repo update
      - helm upgrade prometheus oci://ghcr.io/prometheus-community/charts/kube-prometheus-stack --version 80.4.1
          --install
          -f helm/monitoring/values.yaml
          -n prometheus
          --create-namespace
  
  monitoring:uninstall:
    desc: ğŸ—‘ï¸  Desinstalar Prometheus y Grafana
    cmds:
      - helm uninstall prometheus -n prometheus
      - echo "âœ“ Prometheus y Grafana desinstalados"
