apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: github-pr-status
  namespace: devops-lab-cicd
spec:
  description: |
    Actualiza el estado del PR en GitHub usando la API de GitHub Status
  params:
    - name: REPO_URL
      description: "URL del repositorio (ej: https://github.com/owner/repo.git)"
      type: string
    - name: GIT_SHA
      description: SHA del commit
      type: string
    - name: STATE
      description: Estado del check (pending, success, failure, error)
      type: string
      default: "pending"
    - name: DESCRIPTION
      description: Descripci√≥n del estado
      type: string
      default: "Pipeline ejecut√°ndose"
    - name: CONTEXT
      description: Contexto √∫nico del check
      type: string
      default: "tekton/pr-security-pipeline"
    - name: TARGET_URL
      description: URL del pipeline (opcional)
      type: string
      default: ""
  steps:
    - name: update-status
      image: curlimages/curl:latest
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: token
      script: |
        #!/bin/sh
        set -e
        
        REPO_URL="$(params.REPO_URL)"
        GIT_SHA="$(params.GIT_SHA)"
        STATE="$(params.STATE)"
        DESCRIPTION="$(params.DESCRIPTION)"
        CONTEXT="$(params.CONTEXT)"
        TARGET_URL="$(params.TARGET_URL)"
        
        # Extraer owner y repo de la URL
        # Ejemplo: https://github.com/owner/repo.git -> owner/repo
        REPO_PATH=$(echo "$REPO_URL" | sed -E 's|https?://github.com/||' | sed 's|\.git$||')
        
        if [ -z "$REPO_PATH" ]; then
          echo "‚ùå Error: No se pudo extraer owner/repo de la URL: $REPO_URL"
          exit 1
        fi
        
        echo "üîî Actualizando estado del PR en GitHub"
        echo "Repository: $REPO_PATH"
        echo "SHA: $GIT_SHA"
        echo "State: $STATE"
        echo "Description: $DESCRIPTION"
        
        # Preparar el JSON del body
        if [ -n "$TARGET_URL" ] && [ "$TARGET_URL" != "" ]; then
          BODY=$(cat <<EOF
        {
          "state": "$STATE",
          "target_url": "$TARGET_URL",
          "description": "$DESCRIPTION",
          "context": "$CONTEXT"
        }
        EOF
          )
        else
          BODY=$(cat <<EOF
        {
          "state": "$STATE",
          "description": "$DESCRIPTION",
          "context": "$CONTEXT"
        }
        EOF
          )
        fi
        
        # Hacer la petici√≥n a la API de GitHub
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/json" \
          -d "$BODY" \
          "https://api.github.com/repos/$REPO_PATH/statuses/$GIT_SHA")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
        
        if [ "$HTTP_CODE" -eq 201 ]; then
          echo "‚úÖ Estado actualizado correctamente en GitHub"
          echo "$RESPONSE_BODY"
        else
          echo "‚ùå Error al actualizar estado. HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi

