apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: github-pr-comment
  namespace: devops-lab-cicd
spec:
  description: |
    Env√≠a un comentario a un Pull Request en GitHub
  params:
    - name: REPO_URL
      description: "URL del repositorio (ej: https://github.com/owner/repo.git)"
      type: string
    - name: PR_NUMBER
      description: N√∫mero del Pull Request
      type: string
    - name: COMMENT_BODY
      description: Contenido del comentario (markdown)
      type: string
  steps:
    - name: post-comment
      image: curlimages/curl:latest
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: token
      script: |
        #!/bin/sh
        set -e
        
        REPO_URL="$(params.REPO_URL)"
        PR_NUMBER="$(params.PR_NUMBER)"
        COMMENT_BODY="$(params.COMMENT_BODY)"
        
        # Extraer owner y repo de la URL
        REPO_PATH=$(echo "$REPO_URL" | sed -E 's|https?://github.com/||' | sed 's|\.git$||')
        
        if [ -z "$REPO_PATH" ]; then
          echo "‚ùå Error: No se pudo extraer owner/repo de la URL: $REPO_URL"
          exit 1
        fi
        
        echo "üí¨ Enviando comentario al PR #$PR_NUMBER en $REPO_PATH"
        
        # Preparar el JSON del body
        # Escapar el comentario para JSON manualmente (reemplazar comillas dobles, saltos de l√≠nea, etc.)
        COMMENT_ESCAPED=$(echo "$COMMENT_BODY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
        
        BODY=$(cat <<EOF
        {
          "body": "$COMMENT_ESCAPED"
        }
        EOF
        )
        
        # Hacer la petici√≥n a la API de GitHub
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/json" \
          -d "$BODY" \
          "https://api.github.com/repos/$REPO_PATH/issues/$PR_NUMBER/comments")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
        
        if [ "$HTTP_CODE" -eq 201 ]; then
          echo "‚úÖ Comentario publicado correctamente en el PR"
          echo "$RESPONSE_BODY"
        else
          echo "‚ùå Error al publicar comentario. HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi

