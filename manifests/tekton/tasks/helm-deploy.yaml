apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-deploy
  namespace: devops-lab-cicd
spec:
  description: |
    Deploys an application using Helm upgrade --install
  params:
    - name: RELEASE_NAME
      type: string
      description: Helm release name
    - name: NAMESPACE
      type: string
      description: Namespace for Helm deployment
    - name: VALUES_FILE
      type: string
      description: Path to values file relative to workspace root
    - name: CHART_PATH
      type: string
      description: Path to Helm chart relative to workspace root
      default: helm/devops-lab-app
    - name: IMAGE_REFERENCE
      type: string
      description: "Full image reference with tag (ej: docker.io/user/repo:v1.0.0)"
      default: ""
  steps:
    - name: helm-upgrade-install
      image: alpine/helm:3.19
      command:
        - /bin/sh
      args:
        - -c
        - |
          cd $(workspaces.source.path)
          
          echo "üîç IMAGE_REFERENCE recibido: $(params.IMAGE_REFERENCE)"
          
          if [ -n "$(params.IMAGE_REFERENCE)" ]; then
            IMAGE_REF="$(params.IMAGE_REFERENCE)"
            IMAGE_REPO=$(echo "$IMAGE_REF" | sed 's/:.*$//')
            IMAGE_TAG=$(echo "$IMAGE_REF" | sed 's/^.*://')
            echo "üì¶ Extrayendo: repository='$IMAGE_REPO', tag='$IMAGE_TAG'"
            
            helm upgrade --install $(params.RELEASE_NAME) $(params.CHART_PATH) \
              -f $(params.VALUES_FILE) \
              -n $(params.NAMESPACE) \
              --create-namespace \
              --set image.repository="$IMAGE_REPO" \
              --set image.tag="$IMAGE_TAG"
          else
            echo "‚ö†Ô∏è  No se proporcion√≥ IMAGE_REFERENCE, usando valores por defecto del values file"
            helm upgrade --install $(params.RELEASE_NAME) $(params.CHART_PATH) \
              -f $(params.VALUES_FILE) \
              -n $(params.NAMESPACE) \
              --create-namespace
          fi
  workspaces:
    - name: source
      description: Workspace containing the source code and Helm chart

