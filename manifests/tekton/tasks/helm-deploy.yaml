apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-deploy
  namespace: devops-lab-cicd
spec:
  description: |
    Deploys an application using Helm upgrade --install
  params:
    - name: RELEASE_NAME
      type: string
      description: Helm release name
    - name: NAMESPACE
      type: string
      description: Namespace for Helm deployment
    - name: VALUES_FILE
      type: string
      description: Path to values file relative to workspace root
    - name: CHART_PATH
      type: string
      description: Path to Helm chart relative to workspace root
      default: helm/devops-lab-app
    - name: IMAGE_REFERENCE
      type: string
      description: Full image reference with tag (ej: docker.io/user/repo:v1.0.0)
      default: ""
  steps:
    - name: helm-upgrade-install
      image: alpine/helm:3.19
      command:
        - /bin/sh
      args:
        - -c
        - |
          cd $(workspaces.source.path)
          
          HELM_CMD="helm upgrade --install $(params.RELEASE_NAME) $(params.CHART_PATH) -f $(params.VALUES_FILE) -n $(params.NAMESPACE) --create-namespace"
          
          if [ -n "$(params.IMAGE_REFERENCE)" ]; then
            IMAGE_REPO=$(echo "$(params.IMAGE_REFERENCE)" | cut -d: -f1)
            IMAGE_TAG=$(echo "$(params.IMAGE_REFERENCE)" | cut -d: -f2)
            HELM_CMD="$HELM_CMD --set image.repository=$IMAGE_REPO --set image.tag=$IMAGE_TAG"
          fi
          
          eval $HELM_CMD
  workspaces:
    - name: source
      description: Workspace containing the source code and Helm chart

